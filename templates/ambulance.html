<!DOCTYPE html>
<html>
<head>
    <title>Ambulance Mode</title>
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; }
        h3 { position: absolute; top: 10px; left: 10px; z-index: 10; background: white; padding: 10px; margin: 0; border-radius: 4px; box-shadow: 0 2px 6px rgba(0,0,0,0.3); }
        #map { height: 100vh; width: 100%; display: none; }
        #placeholder { 
            height: 100vh; 
            width: 100%; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            background: #f0f0f0; 
            color: #555; 
            font-size: 24px; 
            flex-direction: column;
        }
        #controls { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 10; display: flex; gap: 10px; }
        #status { background: white; padding: 10px 20px; border-radius: 30px; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        
        .btn-toggle {
            padding: 10px 20px;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: background 0.3s;
        }
        .btn-off { background-color: #4CAF50; color: white; } /* Green for "Go Online / Start" */
        .btn-off { background-color: #4CAF50; color: white; } /* Green for "Go Online / Start" */
        .btn-on { background-color: #f44336; color: white; } /* Red for "Stop Emergency" */
        
        #info-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            z-index: 10;
            display: none;
            text-align: right;
        }
        #info-panel div { margin-bottom: 5px; }
        .hosp-name { font-weight: bold; font-size: 18px; color: #d32f2f; }
        .eta-time { font-size: 24px; font-weight: bold; color: #1a237e; }
    </style>
</head>
<body>
    <h3>ðŸš‘ Ambulance Mode</h3>
    
    <div id="controls">
        <div id="status">Standby</div>
        <button id="toggleBtn" class="btn-toggle btn-off" onclick="toggleEmergency()">Start Emergency</button>
    </div>

    <div id="info-panel">
        <div>Destination Hospital</div>
        <div id="hosp-name" class="hosp-name">--</div>
        <div id="eta-text" class="eta-time">-- min</div>
    </div>

    <div id="placeholder">
        <div style="font-size: 60px; margin-bottom: 20px;">ðŸš‘</div>
        Status: Standby<br>
        <span style="font-size: 18px; margin-top: 10px;">Turn ON Emergency to View Map</span>
    </div>
    <div id="map"></div>

    <script>
        let map, ambulanceMarker, destMarker;
        const statusDiv = document.getElementById('status');
        const toggleBtn = document.getElementById('toggleBtn');
        const infoPanel = document.getElementById('info-panel');
        const hospNameDiv = document.getElementById('hosp-name');
        const etaTextDiv = document.getElementById('eta-text');
        
        let isEmergency = false;
        let currentLat = 0;
        let currentLng = 0;
        
        // Voice State
        let announcedStart = false;
        let announcedArrival = false;

        function speak(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 1.0;
                utterance.pitch = 1.0;
                window.speechSynthesis.speak(utterance);
            }
        }

        function toggleEmergency() {
            isEmergency = !isEmergency;
            
            // Reset Voice State on Toggle
            if (isEmergency) {
                announcedStart = false; 
                announcedArrival = false;
            } else {
                speak("Emergency mode deactivated. Returning to standby.");
            }
            
            updateUI();
            // Send update immediately to reflect status change
            sendUpdate(currentLat, currentLng);
        }

        function updateUI() {
            const mapDiv = document.getElementById('map');
            const placeholder = document.getElementById('placeholder');

            if (isEmergency) {
                statusDiv.innerText = "ðŸš¨ EMERGENCY ON";
                statusDiv.style.color = "red";
                toggleBtn.innerText = "Stop Emergency";
                toggleBtn.className = "btn-toggle btn-on";
                
                // Show Map
                mapDiv.style.display = "block";
                placeholder.style.display = "none";
                
                // Resize event often needed when un-hiding google maps
                google.maps.event.trigger(map, "resize"); 
            } else {
                statusDiv.innerText = "Standby mode";
                statusDiv.style.color = "black";
                toggleBtn.innerText = "Start Emergency";
                toggleBtn.className = "btn-toggle btn-off";
                
                // Hide Map
                mapDiv.style.display = "none";
                placeholder.style.display = "flex";
            }
        }

        function initMap() {
            // Default center (Coimbatore approx from index.html)
            const initialPos = { lat: 11.0168, lng: 76.9558 };
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 15,
                center: initialPos,
            });

            ambulanceMarker = new google.maps.Marker({
                position: initialPos,
                map: map,
                title: "Ambulance",
                icon: "https://maps.google.com/mapfiles/ms/icons/truck.png"
            });

            startTracking();
        }

        function startTracking() {
            if (!navigator.geolocation) {
                statusDiv.innerText = "Geolocation not supported";
                return;
            }

            navigator.geolocation.watchPosition(
                (pos) => {
                    currentLat = pos.coords.latitude;
                    currentLng = pos.coords.longitude;
                    const position = { lat: currentLat, lng: currentLng };

                    // Update Map
                    if (map && ambulanceMarker) {
                        ambulanceMarker.setPosition(position);
                        map.setCenter(position);
                    }

                    // Send to Server
                    sendUpdate(currentLat, currentLng);
                },
                (err) => {
                    console.error(err);
                },
                {
                    enableHighAccuracy: true
                }
            );
        }

        function sendUpdate(lat, lng) {
            if (lat === 0 && lng === 0) return; // Don't send invalid coordinates

            fetch("/update_ambulance", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    lat: lat, 
                    lng: lng,
                    status: isEmergency ? 'ON' : 'OFF'
                })
            })
            .then(res => res.json())
            .then(data => {
                if (isEmergency && data.hospital) {
                    infoPanel.style.display = "block";
                    hospNameDiv.innerText = data.hospital.name;
                    
                    let mins = Math.ceil(data.eta_seconds / 60);
                    if (mins < 1) mins = 1;
                    if (mins === 1 && data.eta_seconds < 30) etaTextDiv.innerText = "< 1 min";
                    else etaTextDiv.innerText = mins + " min";
                    
                    // VOICE: Announcement Logic
                    if (!announcedStart) {
                        speak(`Emergency Activated. Routing to ${data.hospital.name}. Estimated time ${mins} minutes.`);
                        announcedStart = true;
                    }
                    
                    if (mins === 1 && data.eta_seconds < 45 && !announcedArrival) {
                        speak(`Arriving at ${data.hospital.name} in less than one minute.`);
                        announcedArrival = true;
                    }
                    
                    // Update Destination Marker
                    if (!destMarker) {
                        destMarker = new google.maps.Marker({
                            position: data.hospital,
                            map: map,
                            title: data.hospital.name,
                            icon: "https://maps.google.com/mapfiles/ms/icons/hospitals.png"
                        });
                    } else {
                        destMarker.setPosition(data.hospital);
                        destMarker.setMap(map); // Ensure visible
                    }
                } else {
                    infoPanel.style.display = "none";
                    if (destMarker) destMarker.setMap(null);
                }
            })
            .catch(err => console.error("Error sending update:", err));
        }
    </script>
    
    <!-- Using the same key found in index.html -->
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAE3DmEpgRZI-0m6ERMPbc3sECXaQe_-Ts&callback=initMap">
    </script>
</body>
</html>
