<!DOCTYPE html>
<html>
<head>
<title>User â€“ Ambulance Alert</title>
<style>
  body { margin: 0; font-family: sans-serif; }
  #map { height: 100vh; width: 100%; display: none; }
  #placeholder { 
      height: 100vh; 
      width: 100%; 
      display: flex; 
      justify-content: center; 
      align-items: center; 
      background: #e3f2fd; 
      color: #1565c0; 
      font-size: 24px; 
      flex-direction: column;
      text-align: center;
  }
  
  #alert-popup {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background-color: red;
    color: white;
    padding: 20px;
    font-size: 18px;
    font-weight: bold;
    border-radius: 10px;
    z-index: 100;
    text-align: center;
    box-shadow: 0 0 20px rgba(255, 0, 0, 0.8);
    display: none;
    animation: flash 1s infinite alternate;
  }
  
  @keyframes flash {
    from { opacity: 1; }
    to { opacity: 0.8; transform: scale(0.95); }
  }
  
  #eta-display {
    position: fixed;
    top: 80px; 
    right: 20px;
    background: #fff;
    border: 2px solid #ff0000;
    padding: 10px 20px;
    border-radius: 30px;
    font-weight: bold;
    color: #d32f2f;
    font-size: 20px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    display: none;
    z-index: 100;
  }
</style>
</head>
<body>

<div id="controls">
    <button onclick="startRoadMode()">Road Mode ON</button>
    <button onclick="stopRoadMode()">OFF</button>
    <span id="status-text">Mode: OFF</span>
</div>

<div id="alert-popup">
    ðŸš‘ AMBULANCE NEARBY!<br>
    PLEASE GIVE WAY!
</div>

<div id="placeholder">
    <div style="font-size: 60px; margin-bottom: 20px;">ðŸš—</div>
    <h3>Road Mode OFF</h3>
    <p>Please click "Road Mode ON" to connect to the network<br>and view roadway warnings.</p>
</div>

<div id="map"></div>

<script>
let map, userMarker, ambMarker, hospMarker;
let road = false;
const alertPopup = document.getElementById('alert-popup');
const statusText = document.getElementById('status-text');
const mapDiv = document.getElementById('map');
const placeholder = document.getElementById('placeholder');
let notificationPermitted = false;
let isAlerting = false;

function startRoadMode() {
    road = true;
    statusText.innerText = "Mode: ON";
    
    // Show Map
    mapDiv.style.display = "block";
    placeholder.style.display = "none";
    if(map) google.maps.event.trigger(map, "resize");

    // Request permission explicitly on user interaction
    if (Notification.permission !== "denied") {
        Notification.requestPermission().then(p => {
            notificationPermitted = (p === "granted");
        });
    }
}

function stopRoadMode() {
    road = false;
    statusText.innerText = "Mode: OFF";
    alertPopup.style.display = "none";
    
    // Hide Map
    mapDiv.style.display = "none";
    placeholder.style.display = "flex";
}

function initMap(){
  map = new google.maps.Map(document.getElementById("map"), {
    center:{lat:11.0168,lng:76.9558}, zoom:14
  });

  navigator.geolocation.watchPosition(pos=>{
    let lat = pos.coords.latitude;
    let lng = pos.coords.longitude;
    let speed = pos.coords.speed ? pos.coords.speed*3.6 : 0;

    if(!userMarker){
      userMarker = new google.maps.Marker({position:{lat,lng},map});
      map.setCenter({lat,lng});
    } else userMarker.setPosition({lat,lng});

    fetch("/update_user",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({lat,lng,speed})
    });
  });

  setInterval(()=>{
    fetch("/check_nearby")
    .then(r=>r.json())
    .then(d=>{
      console.log("Check result:", d, "Road Mode:", road); 
      if(d.amb){
        if(!ambMarker){
          ambMarker = new google.maps.Marker({
            position:d.amb,
            map,
            icon:"https://maps.google.com/mapfiles/ms/icons/truck.png"
          });
        } else ambMarker.setPosition(d.amb);
      }
      
      if(d.alert && road){
        showAlert();
      } else {
        hideAlert();
      }
      
      // Hospital Marker
      if (d.hospital) {
          if (!hospMarker) {
              hospMarker = new google.maps.Marker({
                  position: d.hospital,
                  map: map,
                  title: d.hospital.name,
                  icon: "https://maps.google.com/mapfiles/ms/icons/hospitals.png" // Reliable Hospital Icon
              });
          } else {
            hospMarker.setPosition(d.hospital);
          }
      }
      
      // ETA Display REMOVED as per request
    });
  },3000);
}

    function showAlert() {
        // Show visual popup always (it's passive)
        alertPopup.style.display = "block";
        
        // Only play sound and send system notification if not already alerting
        if (!isAlerting) {
            new Audio("/static/siren.mp3").play().catch(e => console.log("Audio autoplay blocked"));

            if (Notification.permission === "granted") {
                new Notification("ðŸš‘ Ambulance Nearby", { 
                    body: "An ambulance is approaching your location. Please give way.",
                    icon: "/static/siren.png"
                });
            }
            isAlerting = true;
        }
    }

    function hideAlert() {
        alertPopup.style.display = "none";
        isAlerting = false;
    }

</script>

<script async defer
src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAE3DmEpgRZI-0m6ERMPbc3sECXaQe_-Ts&callback=initMap">
</script>

</body>
</html>
